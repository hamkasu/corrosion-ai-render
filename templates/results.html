{% extends "base.html" %}
{% block title %}Detection Result{% endblock %}
{% block content %}
<h1 class="text-success mb-4">Detection Complete</h1>
<div class="alert alert-success mb-4">
    <h5>Inspection Result</h5>
    <p>{{ result_text|safe }}</p>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="img-container">
            <h6>Original Image</h6>
            <img src="/static/uploads/{{ filename }}" class="w-100" style="border-radius:8px;">
        </div>
    </div>
    <div class="col-md-6">
        <div class="img-container">
            <h6>Detected & Markup</h6>
            <img src="/static/results/{{ result_filename }}" class="w-100" style="border-radius:8px;" onerror="this.src='/static/results/no_detection.jpg'">
        </div>
    </div>
</div>

<!-- Rename Report -->
<div class="comment-box mb-4">
    <label><strong>ğŸ“‹ Report Name</strong></label>
    <input type="text" id="custom_name" value="{{ custom_name }}" class="form-control mb-2">
    <button onclick="saveCustomName('{{ result_filename }}')" class="btn btn-primary w-100">Save Name</button>
    <div id="nameStatus" class="mt-2 text-center"></div>
</div>

<!-- Comments -->
<div class="comment-box mb-4">
    <label><strong>ğŸ’¬ Comments & Observations</strong></label>
    <textarea id="comment" class="form-control mb-2" rows="3">{{ comments }}</textarea>
    <button onclick="saveComment('{{ result_filename }}')" class="btn btn-success w-100">Save Comment</button>
    <div id="commentStatus" class="mt-2 text-center"></div>
</div>

<!-- Feedback -->
<div class="mt-4 p-3 bg-light rounded">
    <p><strong>Was this result correct?</strong></p>
    <a href="/confirm/{{ result_filename }}?correct=true" class="btn btn-success me-2">Yes, Correct</a>
    <a href="/confirm/{{ result_filename }}?correct=false" class="btn btn-danger">No, Incorrect</a>
</div>

<!-- Navigation -->
<a href="/" class="btn btn-outline-primary me-2">ğŸ  Home</a>
<a href="/reports" class="btn btn-secondary">âŒ Close</a>

<!-- JavaScript -->
<script>
function saveCustomName(resultFilename) {
    const val = document.getElementById('custom_name').value;
    fetch('/rename_report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ result_image: resultFilename, custom_name: val })
    })
    .then(r => r.json())
    .then(d => {
        document.getElementById('nameStatus').innerHTML = d.success ? '<span class="text-success">âœ… Name saved!</span>' : '<span class="text-danger">âŒ Save failed</span>';
    });
}

function saveComment(resultFilename) {
    const val = document.getElementById('comment').value;
    fetch('/save_comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ result_image: resultFilename, comment: val })
    })
    .then(r => r.json())
    .then(d => {
        document.getElementById('commentStatus').innerHTML = d.success ? '<span class="text-success">âœ… Comment saved!</span>' : '<span class="text-danger">âŒ Save failed</span>';
    });
}
</script>
{% endblock %}